version: '3.8'

services:
 postgres:
  image: postgres:15-alpine
  container_name: real_time_chat_db
  env_file:
   - .env
  environment:
   - POSTGRES_USER=${POSTGRES_USER}
   - POSTGRES_PASSWORD=${POSTGRES_PASSWORD}
   - POSTGRES_DB=${POSTGRES_DB}
  ports:
   - '5432:5432'
  volumes:
   - pgdata:/var/lib/postgresql/data
  networks:
   - real_time_chat_network
  healthcheck:
   test: ['CMD-SHELL', 'pg_isready -U ${POSTGRES_USER:-postgres}']
   interval: 10s
   timeout: 5s
   retries: 5

 app:
  build: .
  container_name: real_time_chat_app
  ports:
   - '3000:3000'
  environment:
   NODE_ENV: ${NODE_ENV:-development}
   PORT: ${PORT:-3000}
   DATABASE_URL: postgresql://${POSTGRES_USER:-postgres}:${POSTGRES_PASSWORD:-password}@postgres:5432/${POSTGRES_DB:-flag_feature}?schema=public
   PUBLIC_BASE_URL: ${PUBLIC_BASE_URL:-http://localhost:3000}
  depends_on:
   postgres:
    condition: service_healthy
  networks:
   - real_time_chat_network
  volumes:
   - .:/app
   - /app/node_modules
  command: sh -c "npm install && npx prisma generate && npx prisma migrate deploy && npm run dev"
  healthcheck:
   test: ['CMD', 'wget', '--no-verbose', '--tries=1', '--spider', 'http://localhost:3000/health']
   interval: 30s
   timeout: 10s
   retries: 3
   start_period: 40s

 postgres-test:
  image: postgres:15-alpine
  container_name: real_time_chat_db_test
  env_file:
   - .env
  environment:
   - POSTGRES_USER=${POSTGRES_USER}
   - POSTGRES_PASSWORD=${POSTGRES_PASSWORD}
   - POSTGRES_DB=${POSTGRES_DB}_test
  ports:
   - '5433:5432'
  volumes:
   - pgdata_test:/var/lib/postgresql/data
  networks:
   - real_time_chat_network
  healthcheck:
   test: ['CMD-SHELL', 'pg_isready -U ${POSTGRES_USER:-postgres}']
   interval: 10s
   timeout: 5s
   retries: 5

 test:
  build:
   context: .
   dockerfile: Dockerfile.test
  container_name: real_time_chat_test
  environment:
   NODE_ENV: test
   DATABASE_URL: postgresql://${POSTGRES_USER:-postgres}:${POSTGRES_PASSWORD:-password}@postgres-test:5432/${POSTGRES_DB:-flag_feature}_test?schema=public
   TEST_DATABASE_URL: postgresql://${POSTGRES_USER:-postgres}:${POSTGRES_PASSWORD:-password}@postgres-test:5432/${POSTGRES_DB:-flag_feature}_test?schema=public
   ACCESS_TOKEN_SECRET: ${ACCESS_TOKEN_SECRET:-test-access-secret-key}
   REFRESH_TOKEN_SECRET: ${REFRESH_TOKEN_SECRET:-test-refresh-secret-key}
  depends_on:
   postgres-test:
    condition: service_healthy
  networks:
   - real_time_chat_network
  volumes:
   - .:/app
   - /app/node_modules
  command: sh -c "npx prisma migrate deploy && npm run test"

volumes:
 pgdata:
 pgdata_test:

networks:
 real_time_chat_network:
  driver: bridge
